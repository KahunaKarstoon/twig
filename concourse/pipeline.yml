---
resource_types:
  - name: npm-cache
    type: docker-image
    source: {repository: ymedlop/npm-cache-resource, tag: "latest"}

resources:
- name: twig
  type: git
  source: &repo-source
    uri: https://github.com/buildit/twig.git
    branch: concourse
- name: dependency-cache
  type: npm-cache
  source:
    <<: *repo-source
    paths:
      - package.json
- name: twig-docker-image
  type: docker-image
  source:
    email: {{docker-hub-email}}
    username: {{docker-hub-username}}
    password: {{docker-hub-password}}
    repository: {{docker-hub-repo}}

jobs:
- name: Install Dependencies
  plan:
    - get: twig
      trigger: true
    - get: dependency-cache

# - name: Run Tests
#   plan:
#     - get: twig
#       trigger: true
#       passed: [Install Dependencies]
#     - get: dependency-cache
#       passed: [Install Dependencies]
#     - task: handle dependencies
#       file: twig/concourse/tasks/dependencies.yml
#     - task: lint the project
#       file: twig/concourse/tasks/lint.yml
#     - task: run the unit tests
#       file: twig/concourse/tasks/run_unit_tests.yml

- name: Deploy
  serial: true
  plan:
    - get: twig
      trigger: true
      passed: [Install Dependencies]
    - get: dependency-cache
      passed: [Install Dependencies]
    - task: handle dependencies
      file: twig/concourse/tasks/dependencies.yml
    - task: compile angular project
      file: twig/concourse/tasks/compile.yml
    - put: twig-docker-image
      params:
        build: twig-with-dist
